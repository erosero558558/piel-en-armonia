<?php

$baseUrl = getenv('TEST_BASE_URL') ?: 'http://localhost:8080';
$cookieFile = __DIR__ . '/cookie.txt';

echo "Starting Penetration Testing...\n";

// --- XSS Test ---
echo "\n[TEST 1] XSS Test (Booking Form)\n";
$tomorrow = date('Y-m-d', strtotime('+1 day'));
$xssPayload = '<script>console.log("XSS")</script>';
$bookingData = [
    'name' => "XSS Test $xssPayload",
    'email' => 'xss@test.com',
    'phone' => '0991234567',
    'date' => $tomorrow,
    'time' => '11:00',
    'service' => 'consulta',
    'doctor' => 'indiferente',
    'privacyConsent' => true,
    'paymentMethod' => 'cash'
];

$ch = curl_init($baseUrl . '/api.php?resource=appointments');
curl_setopt($ch, CURLOPT_POST, true);
curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($bookingData));
curl_setopt($ch, CURLOPT_HTTPHEADER, ['Content-Type: application/json']);
curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
$response = curl_exec($ch);
$httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
curl_close($ch);

if ($httpCode === 201) {
    echo "SUCCESS: Payload stored (Expected behavior, rendering sanitization verified manually in admin.js).\n";
} else {
    echo "WARNING: Payload rejected with code $httpCode (This is good too).\n";
}


// --- Auth Bypass Test ---
echo "\n[TEST 2] Auth Bypass (GET /appointments - Admin only)\n";
$ch = curl_init($baseUrl . '/api.php?resource=appointments');
curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
$response = curl_exec($ch);
$httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
curl_close($ch);

if ($httpCode === 401) {
    echo "SUCCESS: Access denied (401) as expected.\n";
} else {
    echo "FAILED: Expected 401, got $httpCode.\n";
}


// --- CSRF Test ---
echo "\n[TEST 3] CSRF Test (Admin PATCH without Token)\n";

// 1. Login to get session
$password = getenv('PIELARMONIA_ADMIN_PASSWORD') ?: 'admin123';
$loginData = ['password' => $password];
$ch = curl_init($baseUrl . '/admin-auth.php?action=login');
curl_setopt($ch, CURLOPT_POST, true);
curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($loginData));
curl_setopt($ch, CURLOPT_COOKIEJAR, $cookieFile);
curl_setopt($ch, CURLOPT_COOKIEFILE, $cookieFile);
curl_setopt($ch, CURLOPT_HTTPHEADER, ['Content-Type: application/json']);
curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
$response = curl_exec($ch);
$loginCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
curl_close($ch);

if ($loginCode !== 200) {
    echo "SKIPPING CSRF TEST: Login failed ($loginCode).\n";
} else {
    // 2. Try PATCH without CSRF header
    $patchData = ['id' => 1, 'status' => 'cancelled']; // Assuming ID 1 exists
    $ch = curl_init($baseUrl . '/api.php?resource=appointments');
    curl_setopt($ch, CURLOPT_CUSTOMREQUEST, 'PATCH');
    curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($patchData));
    curl_setopt($ch, CURLOPT_COOKIEFILE, $cookieFile); // Use session
    curl_setopt($ch, CURLOPT_HTTPHEADER, ['Content-Type: application/json']);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    $response = curl_exec($ch);
    $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    curl_close($ch);

    if ($httpCode === 400 || $httpCode === 401 || $httpCode === 403) {
        echo "SUCCESS: Request rejected ($httpCode) due to missing CSRF token.\n";
    } else {
        echo "FAILED: Expected 400/401/403, got $httpCode. CSRF might be bypassed.\n";
    }
}


// --- Rate Limiting Test ---
echo "\n[TEST 4] Rate Limiting (POST /appointments)\n";
$bookingData['name'] = 'Rate Limit Test';

// Reset rate limit file first if possible (by deleting ratelimit dir? No, can't easily. Just hammer it.)
// We already sent 1 request in TEST 1.
// We sent 1 in verify_backups too (different script, different connection? Same IP likely).
// Limit is 5 per 60s per IP.
// So we expect failure soon.

for ($i = 1; $i <= 6; $i++) {
    $ch = curl_init($baseUrl . '/api.php?resource=appointments');
    curl_setopt($ch, CURLOPT_POST, true);
    curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($bookingData));
    curl_setopt($ch, CURLOPT_HTTPHEADER, ['Content-Type: application/json']);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    $response = curl_exec($ch);
    $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    curl_close($ch);

    echo "Request $i: Code $httpCode\n";
    if ($httpCode === 429) {
        echo "SUCCESS: Rate limit triggered at request $i.\n";
        break;
    }
    if ($i === 6 && $httpCode !== 429) {
        echo "FAILED: Rate limit not triggered after 6 attempts (plus previous ones).\n";
    }
}

// Cleanup
if (file_exists($cookieFile)) {
    unlink($cookieFile);
}

echo "\nPenetration Testing Complete.\n";
