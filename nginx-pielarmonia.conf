## ── Piel en Armonía – Configuración Nginx ──────────────
## Archivo: /etc/nginx/sites-available/pielarmonia
## Activar: ln -sf /etc/nginx/sites-available/pielarmonia /etc/nginx/sites-enabled/
## Probar: nginx -t && systemctl reload nginx
##
## INSTRUCCIONES PARA EL ADMINISTRADOR DEL VPS:
## 1. Copiar este archivo a /etc/nginx/sites-available/pielarmonia
## 2. Reemplazar la configuración actual del sitio (o hacer merge)
## 3. Ajustar la ruta root si difiere de /var/www/figo
## 4. Ejecutar: nginx -t && systemctl reload nginx

server {
    listen 8080 default_server;
    server_name pielarmonia.com www.pielarmonia.com;

    root /var/www/figo;
    index index.php index.html;

    # ── Cabeceras de seguridad globales ──────────────────
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Content-Security-Policy "default-src 'self'; base-uri 'self'; object-src 'none'; frame-ancestors 'self'; script-src 'self' https://js.stripe.com https://cdnjs.cloudflare.com https://www.googletagmanager.com; style-src 'self' https://fonts.googleapis.com https://cdnjs.cloudflare.com 'unsafe-inline'; font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com; img-src 'self' https://images.unsplash.com https://www.google-analytics.com https://*.stripe.com data:; frame-src https://js.stripe.com https://hooks.stripe.com https://www.google.com; connect-src 'self' https://api.stripe.com https://m.stripe.network https://r.stripe.com https://www.google-analytics.com https://*.google-analytics.com https://*.analytics.google.com; worker-src 'self' blob:; form-action 'self'" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Permissions-Policy "camera=(), microphone=(), geolocation=()" always;
    # HSTS solo si usas HTTPS directo (Cloudflare ya lo maneja)
    # add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    # ── Bloquear archivos sensibles ─────────────────────
    # env.php, .gitignore, .htaccess, *.log, *.md, *.json (excepto sitemap/manifest)
    location ~ (\.env|env\.php|env\.example\.php|\.gitignore|\.htaccess|\.git|\.md$|\.log$) {
        deny all;
        return 403;
    }

    # Bloquear acceso directo a store.json y backups
    location ~ ^/data/ {
        deny all;
        return 403;
    }

    # Bloquear package.json, package-lock.json, playwright.config
    location ~ (package\.json|package-lock\.json|playwright\.config\.js) {
        deny all;
        return 403;
    }

    # Bloquear directorio de tests
    location ~ ^/tests/ {
        deny all;
        return 403;
    }

    # Bloquear node_modules (por si acaso)
    location ~ ^/node_modules/ {
        deny all;
        return 403;
    }

    # ── Compresión gzip ─────────────────────────────────
    gzip on;
    gzip_vary on;
    gzip_min_length 256;
    gzip_proxied any;
    gzip_types
        text/html
        text/css
        text/javascript
        application/javascript
        application/json
        application/xml
        text/xml
        image/svg+xml;

    # ── Caché de estáticos ──────────────────────────────
    location ~* \.(jpg|jpeg|png|webp|gif|ico|svg)$ {
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    location ~* \.(css|js)$ {
        expires 7d;
        add_header Cache-Control "public";
    }

    location ~ ^/(api|figo-chat|figo-backend|admin-auth)\.php$ {
        include fastcgi_params;
        fastcgi_pass unix:/run/php/php-fpm.sock;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_index index.php;
        add_header Cache-Control "no-store, no-cache, must-revalidate, max-age=0" always;
        add_header Pragma "no-cache" always;
        add_header Expires "0" always;
    }

    # ── PHP con php-fpm ─────────────────────────────────
    location ~ \.php$ {
        # Bloquear env.php antes de pasar a PHP
        location ~ env\.php$ {
            deny all;
            return 403;
        }

        include fastcgi_params;
        fastcgi_pass unix:/run/php/php-fpm.sock;
        # Si usan TCP en vez de socket: fastcgi_pass 127.0.0.1:9000;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_index index.php;
    }

    # ── Archivos estáticos y fallback ───────────────────
    location / {
        try_files $uri $uri/ =404;
    }

    # ── Deshabilitar listado de directorios ─────────────
    autoindex off;

    # ── Logs ────────────────────────────────────────────
    access_log /var/log/nginx/pielarmonia-access.log;
    error_log /var/log/nginx/pielarmonia-error.log;
}
