name: Post-Deploy Gate (Git Sync)

on:
  push:
    branches:
      - main
  schedule:
    - cron: "17 */6 * * *"
  workflow_dispatch:
    inputs:
      domain:
        description: "Dominio objetivo"
        required: false
        default: "https://pielarmonia.com"
        type: string
      bench_runs:
        description: "Muestras por endpoint para benchmark"
        required: false
        default: "25"
        type: string
      wait_seconds:
        description: "Espera para sincronizacion del servidor"
        required: false
        default: "90"
        type: string

concurrency:
  group: post-deploy-gate-main
  cancel-in-progress: true

permissions:
  contents: read
  issues: write

jobs:
  gate:
    name: Gate estricto en produccion
    runs-on: windows-latest
    timeout-minutes: 35
    env:
      TARGET_DOMAIN: ${{ github.event.inputs.domain || 'https://pielarmonia.com' }}
      BENCH_RUNS: ${{ github.event.inputs.bench_runs || '25' }}
      WAIT_SECONDS: ${{ github.event.inputs.wait_seconds || '90' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Esperar sincronizacion Git del hosting
        if: ${{ github.event_name == 'push' }}
        shell: pwsh
        run: |
          $waitSeconds = [int]$env:WAIT_SECONDS
          if ($waitSeconds -lt 0) { $waitSeconds = 0 }
          Write-Host "Esperando $waitSeconds segundos para que el servidor termine el pull..."
          Start-Sleep -Seconds $waitSeconds

      - name: Ejecutar gate estricto
        id: gate
        shell: pwsh
        run: |
          $benchRuns = [int]$env:BENCH_RUNS
          if ($benchRuns -lt 10) { $benchRuns = 10 }
          ./GATE-POSTDEPLOY.ps1 `
            -Domain $env:TARGET_DOMAIN `
            -BenchRuns $benchRuns `
            -RequireStableDataDir `
            -RequireBackupHealthy `
            -RequireBackupReceiverReady `
            -RequireCronReady

      - name: Resumen
        if: ${{ always() }}
        shell: pwsh
        run: |
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "## Post-deploy gate"
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "- Dominio: ``$env:TARGET_DOMAIN``"
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "- Bench runs: ``$env:BENCH_RUNS``"
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "- Resultado: ``${{ steps.gate.outcome }}``"

      - name: Crear/actualizar incidente de gate
        if: ${{ failure() && github.event_name != 'workflow_dispatch' }}
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const title = '[ALERTA PROD] Gate post-deploy fallando';
            const runUrl = `${context.serverUrl}/${owner}/${repo}/actions/runs/${context.runId}`;
            const now = new Date().toISOString();
            const body = [
              'El workflow `Post-Deploy Gate (Git Sync)` fallo en produccion.',
              '',
              `- Fecha: ${now}`,
              `- Run: ${runUrl}`,
              `- Workflow: ${context.workflow}`,
              `- Branch: ${context.ref}`
            ].join('\n');

            const openIssues = await github.paginate(github.rest.issues.listForRepo, {
              owner,
              repo,
              state: 'open',
              per_page: 100
            });

            const existing = openIssues.find((issue) => !issue.pull_request && issue.title === title);
            if (existing) {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: existing.number,
                body
              });
              core.info(`Issue existente actualizado: #${existing.number}`);
            } else {
              const created = await github.rest.issues.create({
                owner,
                repo,
                title,
                body
              });
              core.info(`Issue creado: #${created.data.number}`);
            }
