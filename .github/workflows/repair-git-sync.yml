name: Repair Git Sync (Self-Heal)

on:
    workflow_run:
        workflows:
            - Post-Deploy Gate (Git Sync)
        types:
            - completed
    workflow_dispatch:
        inputs:
            domain:
                description: 'Dominio objetivo'
                required: false
                default: 'https://pielarmonia.com'
                type: string
            repo_dir:
                description: 'Ruta remota del repo (opcional, auto-discovery si vacio)'
                required: false
                default: ''
                type: string
            branch:
                description: 'Branch objetivo'
                required: false
                default: 'main'
                type: string

concurrency:
    group: repair-git-sync-main
    cancel-in-progress: false

permissions:
    contents: read
    issues: write

jobs:
    repair:
        name: Repair git sync on server
        runs-on: ubuntu-latest
        timeout-minutes: 20
        if: ${{ github.event_name == 'workflow_dispatch' || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'failure' && github.event.workflow_run.head_branch == 'main') }}
        env:
            TARGET_DOMAIN: ${{ github.event.inputs.domain || vars.PROD_URL || 'https://pielarmonia.com' }}
            TARGET_BRANCH: ${{ github.event.inputs.branch || 'main' }}
            SSH_HOST: ${{ vars.SSH_HOST || secrets.FTP_SERVER }}
            SSH_PORT: ${{ vars.SSH_PORT || '22' }}
            SSH_USERNAME: ${{ secrets.SSH_USERNAME || secrets.FTP_USERNAME }}
            SSH_PASSWORD: ${{ secrets.SSH_PASSWORD || secrets.FTP_PASSWORD }}
            SSH_REPO_DIR: ${{ github.event.inputs.repo_dir || vars.SSH_REPO_DIR || '' }}
            REPO_GIT_URL: https://github.com/erosero558558/piel-en-armonia.git

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Validar credenciales SSH
              shell: bash
              run: |
                  set -euo pipefail
                  if [ -z "${SSH_HOST}" ]; then
                    echo "::error::Falta SSH_HOST (o FTP_SERVER)."
                    exit 1
                  fi
                  if [ -z "${SSH_USERNAME}" ]; then
                    echo "::error::Falta SSH_USERNAME (o FTP_USERNAME)."
                    exit 1
                  fi
                  if [ -z "${SSH_PASSWORD}" ]; then
                    echo "::error::Falta SSH_PASSWORD (o FTP_PASSWORD)."
                    exit 1
                  fi

            - name: Forzar sincronizacion git remota
              uses: appleboy/ssh-action@v1.2.0
              with:
                  host: ${{ env.SSH_HOST }}
                  username: ${{ env.SSH_USERNAME }}
                  password: ${{ env.SSH_PASSWORD }}
                  port: ${{ env.SSH_PORT }}
                  script_stop: true
                  timeout: 120s
                  command_timeout: 15m
                  script: |
                      set -eu
                      BRANCH="${TARGET_BRANCH}"
                      REPO_URL="${REPO_GIT_URL}"
                      REPO_HINT="${SSH_REPO_DIR}"
                      TARGET_REPO=""

                      normalize_url() {
                        echo "$1" | sed -e 's#^git@github.com:#https://github.com/#' -e 's#\.git$##'
                      }

                      matches_repo() {
                        candidate="$1"
                        remote_url="$(git -C "$candidate" remote get-url origin 2>/dev/null || true)"
                        if [ -z "$remote_url" ]; then
                          return 1
                        fi
                        n1="$(normalize_url "$remote_url")"
                        n2="$(normalize_url "$REPO_URL")"
                        [ "$n1" = "$n2" ]
                      }

                      if [ -n "$REPO_HINT" ] && [ -d "$REPO_HINT/.git" ]; then
                        if matches_repo "$REPO_HINT"; then
                          TARGET_REPO="$REPO_HINT"
                        fi
                      fi

                      if [ -z "$TARGET_REPO" ]; then
                        SEARCH_BASES="$HOME /var/www /srv /opt /www /home"
                        for base in $SEARCH_BASES; do
                          [ -d "$base" ] || continue
                          for gitdir in $(find "$base" -maxdepth 6 -type d -name .git 2>/dev/null || true); do
                            candidate="${gitdir%/.git}"
                            if matches_repo "$candidate"; then
                              TARGET_REPO="$candidate"
                              break 2
                            fi
                          done
                        done
                      fi

                      if [ -z "$TARGET_REPO" ]; then
                        echo "No se encontro repo objetivo en el servidor."
                        exit 2
                      fi

                      echo "Repo detectado: $TARGET_REPO"
                      git -C "$TARGET_REPO" remote -v
                      git -C "$TARGET_REPO" fetch --prune origin
                      git -C "$TARGET_REPO" checkout -f "$BRANCH"
                      git -C "$TARGET_REPO" reset --hard "origin/$BRANCH"
                      git -C "$TARGET_REPO" clean -fd
                      echo "HEAD remoto sincronizado:"
                      git -C "$TARGET_REPO" rev-parse --short HEAD
                      git -C "$TARGET_REPO" log -1 --format="%h %ci %s"

            - name: Esperar propagacion de cache
              shell: bash
              run: sleep 35

            - name: Verificar produccion despues de repair
              shell: pwsh
              run: |
                  ./VERIFICAR-DESPLIEGUE.ps1 `
                    -Domain $env:TARGET_DOMAIN `
                    -AssetHashRetryCount 3 `
                    -AssetHashRetryDelaySec 6

            - name: Smoke rapido post-repair
              shell: pwsh
              run: |
                  ./SMOKE-PRODUCCION.ps1 -Domain $env:TARGET_DOMAIN -AllowFigoRateLimit

            - name: Crear/actualizar incidente de repair
              if: ${{ failure() && github.event_name != 'workflow_dispatch' }}
              uses: actions/github-script@v7
              with:
                  script: |
                      const owner = context.repo.owner;
                      const repo = context.repo.repo;
                      const title = '[ALERTA PROD] Repair git sync fallando';
                      const runUrl = `${context.serverUrl}/${owner}/${repo}/actions/runs/${context.runId}`;
                      const now = new Date().toISOString();
                      const body = [
                        'El workflow `Repair Git Sync (Self-Heal)` fallo.',
                        '',
                        `- Fecha: ${now}`,
                        `- Run: ${runUrl}`,
                        `- Trigger: ${context.eventName}`
                      ].join('\n');

                      const openIssues = await github.paginate(github.rest.issues.listForRepo, {
                        owner,
                        repo,
                        state: 'open',
                        per_page: 100
                      });

                      const existing = openIssues.find((issue) => !issue.pull_request && issue.title === title);
                      if (existing) {
                        await github.rest.issues.createComment({
                          owner,
                          repo,
                          issue_number: existing.number,
                          body
                        });
                      } else {
                        await github.rest.issues.create({
                          owner,
                          repo,
                          title,
                          body
                        });
                      }
