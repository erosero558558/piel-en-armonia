name: Deploy Hosting (Canary Pipeline)

on:
    workflow_run:
        workflows: ['CI']
        types:
            - completed
        branches:
            - main
    workflow_dispatch:
        inputs:
            protocol:
                description: 'Protocolo de deploy'
                required: false
                default: 'ftps'
                type: choice
                options:
                    - ftps
                    - ftp
                    - sftp
            server_port:
                description: 'Puerto remoto (21 FTP/FTPS, 22 SFTP)'
                required: false
                default: '21'
                type: string
            security:
                description: 'Validacion TLS para FTPS'
                required: false
                default: 'strict'
                type: choice
                options:
                    - strict
                    - loose
            server_dir:
                description: 'Directorio remoto en hosting'
                required: false
                default: '/public_html/'
                type: string
            dry_run:
                description: 'Simular deploy sin subir archivos'
                required: false
                default: false
                type: boolean
            clean_slate:
                description: 'Eliminar archivos remotos no presentes (peligroso)'
                required: false
                default: false
                type: boolean

concurrency:
    group: deploy-pielarmonia-pipeline
    cancel-in-progress: false

jobs:
    deploy-canary:
        if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
        name: Deploy Canary (Staging)
        runs-on: ubuntu-latest
        timeout-minutes: 20
        env:
            # Staging Configuration
            DEPLOY_PROTOCOL: ${{ github.event.inputs.protocol || vars.STAGING_FTP_PROTOCOL || 'ftps' }}
            FTP_SERVER_PORT: ${{ github.event.inputs.server_port || vars.STAGING_FTP_SERVER_PORT || '21' }}
            FTP_SECURITY: ${{ github.event.inputs.security || vars.STAGING_FTP_SECURITY || 'strict' }}
            FTP_SERVER_DIR: ${{ github.event.inputs.server_dir || vars.STAGING_FTP_SERVER_DIR || '/staging/' }}
            FTP_DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
            FTP_CLEAN_SLATE: ${{ github.event.inputs.clean_slate || 'false' }} # Careful with clean slate on staging if shared
            STAGING_URL: ${{ vars.STAGING_URL || 'https://staging.pielarmonia.com' }}

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup PHP
              uses: shivammathur/setup-php@v2
              with:
                  php-version: '8.2'
                  tools: composer:v2

            - name: Install Dependencies
              run: composer install --no-dev --optimize-autoloader --prefer-dist --no-progress

            - name: Validar secretos requeridos (Staging)
              shell: bash
              run: |
                  set -euo pipefail
                  if [ -z "${{ secrets.STAGING_FTP_SERVER }}" ]; then
                    echo "::error::Falta el secret STAGING_FTP_SERVER"
                    exit 1
                  fi
                  if [ -z "${{ secrets.STAGING_FTP_USERNAME }}" ]; then
                    echo "::error::Falta el secret STAGING_FTP_USERNAME"
                    exit 1
                  fi
                  if [ -z "${{ secrets.STAGING_FTP_PASSWORD }}" ]; then
                    echo "::error::Falta el secret STAGING_FTP_PASSWORD"
                    exit 1
                  fi

            - name: Preflight red (Staging)
              shell: bash
              run: |
                  set -euo pipefail
                  HOST="${{ secrets.STAGING_FTP_SERVER }}"
                  PORT="${FTP_SERVER_PORT}"
                  echo "Testeando conectividad TCP a ${HOST}:${PORT} ..."
                  if timeout 8 bash -c "cat < /dev/null > /dev/tcp/${HOST}/${PORT}" 2>/dev/null; then
                    echo "TCP OK en ${HOST}:${PORT}"
                  else
                    echo "::error::No se puede abrir ${HOST}:${PORT} desde GitHub Runner."
                    exit 1
                  fi

            - name: Preparar bundle de deploy (Staging)
              shell: bash
              run: |
                  set -euo pipefail
                  rm -rf _deploy_bundle
                  mkdir -p _deploy_bundle
                  rsync -a --delete \
                    --exclude='.git*' \
                    --exclude='.github/' \
                    --exclude='.vscode/' \
                    --exclude='.claude/' \
                    --exclude='node_modules/' \
                    --exclude='test-results/' \
                    --exclude='tests/' \
                    --exclude='playwright-report/' \
                    --exclude='_deploy_bundle/' \
                    --exclude='verification/' \
                    --exclude='data/' \
                    --exclude='uploads/' \
                    --exclude='env.php' \
                    --exclude='php.log' \
                    --exclude='*.log' \
                    --exclude='*.zip' \
                    --exclude='*.ps1' \
                    ./ _deploy_bundle/

            - name: Deploy a Staging (FTP/FTPS)
              if: ${{ env.DEPLOY_PROTOCOL != 'sftp' }}
              uses: SamKirkland/FTP-Deploy-Action@v4.3.6
              with:
                  server: ${{ secrets.STAGING_FTP_SERVER }}
                  username: ${{ secrets.STAGING_FTP_USERNAME }}
                  password: ${{ secrets.STAGING_FTP_PASSWORD }}
                  protocol: ${{ env.DEPLOY_PROTOCOL }}
                  port: ${{ env.FTP_SERVER_PORT }}
                  security: ${{ env.FTP_SECURITY }}
                  server-dir: ${{ env.FTP_SERVER_DIR }}
                  local-dir: ./_deploy_bundle/
                  dangerous-clean-slate: ${{ env.FTP_CLEAN_SLATE }}
                  dry-run: ${{ env.FTP_DRY_RUN }}
                  timeout: 120000
                  state-name: .ftp-deploy-sync-state-staging.json

            - name: Deploy a Staging (SFTP)
              if: ${{ env.DEPLOY_PROTOCOL == 'sftp' }}
              shell: bash
              run: |
                  set -euo pipefail
                  if [ "${FTP_DRY_RUN}" = "true" ]; then
                    echo "Dry-run SFTP habilitado: se omite subida real."
                    find _deploy_bundle -maxdepth 2 -type f | head -n 30
                    exit 0
                  fi
                  sudo apt-get update
                  sudo apt-get install -y lftp
                  lftp -u "${{ secrets.STAGING_FTP_USERNAME }}","${{ secrets.STAGING_FTP_PASSWORD }}" "sftp://${{ secrets.STAGING_FTP_SERVER }}:${FTP_SERVER_PORT}" -e "
                    set sftp:auto-confirm yes
                    set net:max-retries 2
                    set net:timeout 20
                    mirror -R --delete --verbose _deploy_bundle/ ${FTP_SERVER_DIR}
                    bye
                  "

            - name: Smoke Tests (Staging)
              if: ${{ env.FTP_DRY_RUN != 'true' }}
              shell: bash
              run: |
                  set -euo pipefail
                  echo "Running smoke tests against ${STAGING_URL}..."
                  # Retry logic for health check
                  for i in {1..5}; do
                    if curl -fsS "${STAGING_URL}/api.php?resource=health" > /tmp/health_staging.json; then
                      echo "Health Check OK"
                      break
                    else
                      echo "Health Check failed, retrying in 5s..."
                      sleep 5
                    fi
                    if [ $i -eq 5 ]; then exit 1; fi
                  done

                  curl -fsS "${STAGING_URL}/figo-chat.php" > /tmp/figo_staging.json
                  curl -IfsS "${STAGING_URL}/" > /tmp/home_staging.txt
                  echo "Staging Verified."

    deploy-prod:
        needs: deploy-canary
        name: Deploy Production
        runs-on: ubuntu-latest
        timeout-minutes: 20
        env:
            # Production Configuration
            DEPLOY_PROTOCOL: ${{ github.event.inputs.protocol || vars.FTP_PROTOCOL || 'ftps' }}
            FTP_SERVER_PORT: ${{ github.event.inputs.server_port || vars.FTP_SERVER_PORT || '21' }}
            FTP_SECURITY: ${{ github.event.inputs.security || vars.FTP_SECURITY || 'strict' }}
            FTP_SERVER_DIR: ${{ github.event.inputs.server_dir || vars.FTP_SERVER_DIR || '/public_html/' }}
            FTP_DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
            FTP_CLEAN_SLATE: ${{ github.event.inputs.clean_slate || 'false' }}
            PROD_URL: ${{ vars.PROD_URL || 'https://pielarmonia.com' }}

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup PHP
              uses: shivammathur/setup-php@v2
              with:
                  php-version: '8.2'
                  tools: composer:v2

            - name: Install Dependencies
              run: composer install --no-dev --optimize-autoloader --prefer-dist --no-progress

            - name: Validar secretos requeridos (Prod)
              shell: bash
              run: |
                  set -euo pipefail
                  if [ -z "${{ secrets.FTP_SERVER }}" ]; then
                    echo "::error::Falta el secret FTP_SERVER"
                    exit 1
                  fi
                  if [ -z "${{ secrets.FTP_USERNAME }}" ]; then
                    echo "::error::Falta el secret FTP_USERNAME"
                    exit 1
                  fi
                  if [ -z "${{ secrets.FTP_PASSWORD }}" ]; then
                    echo "::error::Falta el secret FTP_PASSWORD"
                    exit 1
                  fi

            - name: Preflight red (Prod)
              shell: bash
              run: |
                  set -euo pipefail
                  HOST="${{ secrets.FTP_SERVER }}"
                  PORT="${FTP_SERVER_PORT}"
                  echo "Testeando conectividad TCP a ${HOST}:${PORT} ..."
                  if timeout 8 bash -c "cat < /dev/null > /dev/tcp/${HOST}/${PORT}" 2>/dev/null; then
                    echo "TCP OK en ${HOST}:${PORT}"
                  else
                    echo "::error::No se puede abrir ${HOST}:${PORT} desde GitHub Runner."
                    exit 1
                  fi

            - name: Preparar bundle de deploy (Prod)
              shell: bash
              run: |
                  set -euo pipefail
                  rm -rf _deploy_bundle
                  mkdir -p _deploy_bundle
                  rsync -a --delete \
                    --exclude='.git*' \
                    --exclude='.github/' \
                    --exclude='.vscode/' \
                    --exclude='.claude/' \
                    --exclude='node_modules/' \
                    --exclude='test-results/' \
                    --exclude='tests/' \
                    --exclude='playwright-report/' \
                    --exclude='_deploy_bundle/' \
                    --exclude='verification/' \
                    --exclude='data/' \
                    --exclude='uploads/' \
                    --exclude='env.php' \
                    --exclude='php.log' \
                    --exclude='*.log' \
                    --exclude='*.zip' \
                    --exclude='*.ps1' \
                    ./ _deploy_bundle/

            - name: Deploy a Produccion (FTP/FTPS)
              if: ${{ env.DEPLOY_PROTOCOL != 'sftp' }}
              uses: SamKirkland/FTP-Deploy-Action@v4.3.6
              with:
                  server: ${{ secrets.FTP_SERVER }}
                  username: ${{ secrets.FTP_USERNAME }}
                  password: ${{ secrets.FTP_PASSWORD }}
                  protocol: ${{ env.DEPLOY_PROTOCOL }}
                  port: ${{ env.FTP_SERVER_PORT }}
                  security: ${{ env.FTP_SECURITY }}
                  server-dir: ${{ env.FTP_SERVER_DIR }}
                  local-dir: ./_deploy_bundle/
                  dangerous-clean-slate: ${{ env.FTP_CLEAN_SLATE }}
                  dry-run: ${{ env.FTP_DRY_RUN }}
                  timeout: 120000
                  state-name: .ftp-deploy-sync-state.json

            - name: Deploy a Produccion (SFTP)
              if: ${{ env.DEPLOY_PROTOCOL == 'sftp' }}
              shell: bash
              run: |
                  set -euo pipefail
                  if [ "${FTP_DRY_RUN}" = "true" ]; then
                    echo "Dry-run SFTP habilitado: se omite subida real."
                    find _deploy_bundle -maxdepth 2 -type f | head -n 30
                    exit 0
                  fi
                  sudo apt-get update
                  sudo apt-get install -y lftp
                  lftp -u "${{ secrets.FTP_USERNAME }}","${{ secrets.FTP_PASSWORD }}" "sftp://${{ secrets.FTP_SERVER }}:${FTP_SERVER_PORT}" -e "
                    set sftp:auto-confirm yes
                    set net:max-retries 2
                    set net:timeout 20
                    mirror -R --delete --verbose _deploy_bundle/ ${FTP_SERVER_DIR}
                    bye
                  "

            - name: Smoke Tests (Prod)
              if: ${{ env.FTP_DRY_RUN != 'true' }}
              shell: bash
              run: |
                  set -euo pipefail
                  echo "Running smoke tests against ${PROD_URL}..."
                  curl -fsS "${PROD_URL}/api.php?resource=health" > /tmp/health.json
                  curl -fsS "${PROD_URL}/figo-chat.php" > /tmp/figo.json
                  curl -IfsS "${PROD_URL}/" > /tmp/home_headers.txt
                  echo "Production Verified."
